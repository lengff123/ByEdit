<!DOCTYPE html>
<html lang="en">
<head>
    <title>ByEdit - åŒæ­¥ç¼–è¾‘å™¨</title>
    <style>
        /* æ ¹å˜é‡å®šä¹‰ */
        :root {
            --primary-color: #4CAF50;    /* ä¸»è‰²è°ƒ-ç»¿è‰² */
            --error-color: #f44336;      /* é”™è¯¯è‰²-çº¢è‰² */
            --bg-color: #f5f5f5;         /* èƒŒæ™¯è‰²-æµ…ç° */
            --border-color: #ccc;        /* è¾¹æ¡†è‰²-ç°è‰² */
        }

        /* åŸºç¡€å¸ƒå±€ */
        body {
            margin: 0;
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* å¤´éƒ¨æ ·å¼ */
        .header {
            background: #fff;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            margin: 0;
            font-size: 1.5em;
            color: #333;
        }

        /* ä¸»å®¹å™¨æ ·å¼ */
        .main-container {
            flex: 1;
            padding: 20px;
            display: flex;
            gap: 20px;
        }

        /* ç¼–è¾‘å™¨å®¹å™¨æ ·å¼ */
        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* ç¼–è¾‘å™¨åŒºåŸŸæ ·å¼ */
        .editor-div {
            flex: 1;
            width: 100%;
            font-family: 'Consolas', monospace;
            font-size: 14px;
            padding: 15px;
            box-sizing: border-box;
            border: none;
            outline: none;
            transition: background-color 0.3s;
            white-space: pre-wrap;
            overflow-y: auto;
        }

        /* ç¼–è¾‘å™¨ç¦ç”¨çŠ¶æ€ */
        .editor-div:disabled {
            background-color: #fff;
            color: #000;
            opacity: 0.8;
        }

        /* æ‹–æ‹½çŠ¶æ€æ ·å¼ */
        #editor.dragover {
            background-color: rgba(76, 175, 80, 0.1);
            border: 2px dashed var(--primary-color);
        }

        #editor:disabled {
            background-color: #fff;
            color: #000;
            opacity: 0.8;
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨æ ·å¼ */
        .status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            transition: all 0.3s;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }

        .connected { 
            background-color: var(--primary-color);
            box-shadow: 0 0 10px var(--primary-color);
        }

        .disconnected { 
            background-color: var(--error-color);
            box-shadow: 0 0 10px var(--error-color);
        }

        /* å¤‡ä»½é¢æ¿æ ·å¼ */
        #backups-panel {
            width: 250px;
            background: #fff;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: fixed;
            right: -270px;
            top: 80px;
            transition: right 0.3s ease;
            z-index: 1000;
        }

        #backups-panel.show {
            right: 20px;
        }

        #backups-panel h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1.2em;
        }

        #backup-list {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        /* æŒ‰é’®æ ·å¼ */
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #45a049;
        }

        /* å ä½æ–‡æœ¬æ ·å¼ */
        .placeholder-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #999;
            pointer-events: none;
            text-align: center;
        }

        .placeholder-text i {
            display: block;
            font-size: 2em;
            margin-bottom: 10px;
        }

        /* å¿«æ·é”®æç¤ºæ ·å¼ */
        .shortcut-tip {
            position: fixed;
            right: 20px;
            top: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .shortcut-tip.show {
            opacity: 1;
        }

        /* å¤´éƒ¨æ§åˆ¶åŒºæ ·å¼ */
        .header-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* é¢„è§ˆåˆ‡æ¢æŒ‰é’®æ ·å¼ */
        #preview-toggle {
            background: transparent;
            color: #666;
            padding: 5px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        #preview-toggle.active,
        #preview-toggle:hover {
            background: var(--proof-green);
            color: white;
            border-color: var(--proof-green);
        }

        /* é¢„è§ˆæ¨¡å¼æ ·å¼ */
        .preview-mode {
            background-color: var(--bg-light);
            cursor: default !important;
            box-sizing: border-box;
            min-width: 200px;
            padding: 1em;
            max-width: 980px;
            margin: 0 auto;
            line-height: 1.3;
            color: var(--text-color);
            font-size: 14px;
        }

        #enhanced-preview-toggle {
            background: transparent;
            color: #666;
            padding: 5px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-left: 5px;
        }

        #enhanced-preview-toggle.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        #enhanced-preview-toggle:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
    </style>


    </style>
    <!-- åŸºç¡€æ ·å¼ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“</text></svg>">
    
    <!-- Markdownå’Œlatex æ¸²æŸ“ç›¸å…³æ ·å¼ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5.2.0/github-markdown.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.8.0/build/styles/github.min.css">
    <link rel="stylesheet" href="static/css/preview-renderer.css">
    
    <!-- Markdown è§£æç›¸å…³è„šæœ¬ -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.2/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it-task-lists@2.1.1/dist/markdown-it-task-lists.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it-sup@1.0.0/dist/markdown-it-sup.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it-sub@1.0.0/dist/markdown-it-sub.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it-footnote@3.0.3/dist/markdown-it-footnote.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it-emoji@2.0.2/dist/markdown-it-emoji.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.8.0/build/highlight.min.js"></script>
</head>
<body>
    <div class="header">
        <h1>ByEdit åŒæ­¥ç¼–è¾‘å™¨</h1>
        <div class="header-controls">
            <button id="preview-toggle" title="Ctrl+P åˆ‡æ¢é¢„è§ˆæ¨¡å¼">
                <i class="fas fa-eye"></i>
            </button>
            <button id="enhanced-preview-toggle" title="åˆ‡æ¢å¢å¼ºé¢„è§ˆ" style="display: none;">
                <i class="fas fa-magic"></i>
            </button>
            <div id="status" class="status"></div>
        </div>
    </div>

    <div class="main-container">
        <div class="editor-container">
            <div id="editor" contenteditable="true" spellcheck="true" class="editor-div"></div>
            <div class="placeholder-text">
                <i class="fas fa-file-import"></i>
                æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æ‰“å¼€
            </div>
        </div>

        <div id="backups-panel">
            <h3><i class="fas fa-history"></i> å†å²å¤‡ä»½</h3>
            <select id="backup-list"></select>
            <button onclick="restoreBackup()">
                <i class="fas fa-undo"></i> æ¢å¤
            </button>
        </div>
    </div>

    <div class="shortcut-tip" id="shortcut-tip">æŒ‰ Ctrl+B æ˜¾ç¤º/éšè—å¤‡ä»½é¢æ¿ï¼ŒæŒ‰ Ctrl+P åˆ‡æ¢é¢„è§ˆ/ç¼–è¾‘æ¨¡å¼</div>

    <!-- markdownå’Œlatexæ•°å­¦å…¬å¼å’Œä»£ç é«˜äº®ç›¸å…³è„šæœ¬ -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it-katex@2.0.3/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.8.0/build/highlight.min.js"></script>
    <script src="static/js/preview-renderer.js"></script>
    <script>
        console.log("é¡µé¢åŠ è½½å¼€å§‹");

        let ws = null;
        let isUpdating = false;
        let fileHandle = null;
        let syncInterval = null;
        const editor = document.getElementById('editor');
        const status = document.getElementById('status');

        const INTERVALS = {
            TYPING: 30,        // ä» 50ms å‡å°‘åˆ° 30ms
            ACTIVE: 500,       // ä» 1500ms å‡å°‘åˆ° 500ms
            IDLE: 1000,        // ä» 3000ms å‡å°‘åˆ° 1000ms
            INACTIVE: 2000     // ä» 5000ms å‡å°‘åˆ° 2000ms
        };
        let lastEditTime = Date.now();
        let currentSyncInterval = INTERVALS.INACTIVE;
        const TYPING_INTERVAL = 1000;
        let typingTimer;
        let lastContent = '';

        let isPreviewMode = false;
        let previewRenderer = null;
        let originalContent = '';
        let isEnhancedPreview = false;

        // æ·»åŠ é¢„è§ˆæ¨¡å¼åˆ‡æ¢å¤„ç†
        document.addEventListener('keydown', (e) => {
            // Ctrl+B åˆ‡æ¢å¤‡ä»½é¢æ¿
            if (e.ctrlKey && e.key.toLowerCase() === 'b') {
                e.preventDefault();
                toggleBackupsPanel();
            }
            // Ctrl+P åˆ‡æ¢é¢„è§ˆæ¨¡å¼
            if (e.ctrlKey && e.key.toLowerCase() === 'p') {
                e.preventDefault();
                togglePreviewMode();
            }
        });

        // åˆ‡æ¢é¢„è§ˆæ¨¡å¼
        function togglePreviewMode() {
            isPreviewMode = !isPreviewMode;
            const previewToggleBtn = document.getElementById('preview-toggle');
            const enhancedPreviewBtn = document.getElementById('enhanced-preview-toggle');
            
            if (isPreviewMode) {
                // æ˜¾ç¤ºå¢å¼ºé¢„è§ˆåˆ‡æ¢æŒ‰é’®
                enhancedPreviewBtn.style.display = 'inline-block';
                // è¿›å…¥é¢„è§ˆæ¨¡å¼å‰ä¿å­˜åŸå§‹å†…å®¹
                originalContent = editor.textContent;
                
                editor.contentEditable = false;
                editor.classList.add('preview-mode');
                if (isEnhancedPreview) {
                    editor.classList.add('markdown-body');
                }
                previewToggleBtn.classList.add('active');
                
                renderPreview();
            } else {
                // éšè—å¢å¼ºé¢„è§ˆåˆ‡æ¢æŒ‰é’®
                enhancedPreviewBtn.style.display = 'none';
                // é€€å‡ºé¢„è§ˆæ¨¡å¼
                editor.contentEditable = true;
                editor.classList.remove('preview-mode', 'markdown-body');
                previewToggleBtn.classList.remove('active');
                
                // æ¢å¤ä¿å­˜çš„åŸå§‹å†…å®¹
                editor.textContent = originalContent;
            }
            
            // æ›´æ–°æŒ‰é’®å›¾æ ‡
            const icon = previewToggleBtn.querySelector('i');
            icon.className = isPreviewMode ? 'fas fa-edit' : 'fas fa-eye';
        }

        // åˆ‡æ¢å¢å¼ºé¢„è§ˆ
        function toggleEnhancedPreview() {
            if (!isPreviewMode) return;
            
            isEnhancedPreview = !isEnhancedPreview;
            const enhancedPreviewBtn = document.getElementById('enhanced-preview-toggle');
            
            if (isEnhancedPreview) {
                editor.classList.add('markdown-body');
                enhancedPreviewBtn.classList.add('active');
            } else {
                editor.classList.remove('markdown-body');
                enhancedPreviewBtn.classList.remove('active');
            }
            
            renderPreview();
        }

        // æ¸²æŸ“é¢„è§ˆå†…å®¹
        function renderPreview() {
            if (!isPreviewMode) return;
            
            if (isEnhancedPreview) {
                // ä½¿ç”¨å¢å¼ºé¢„è§ˆæ¸²æŸ“
                if (!previewRenderer) {
                    previewRenderer = new PreviewRenderer();
                }
                const fileType = fileHandle ? previewRenderer.getFileType(fileHandle.name) : 'txt';
                const renderedContent = previewRenderer.render(originalContent, fileType);
                editor.innerHTML = renderedContent;
            } else {
                // åŸºç¡€é¢„è§ˆæ¸²æŸ“
                editor.textContent = originalContent;
            }
        }

        // æ·»åŠ å¢å¼ºé¢„è§ˆæŒ‰é’®äº‹ä»¶ç›‘å¬
        document.getElementById('enhanced-preview-toggle').addEventListener('click', toggleEnhancedPreview);

        // æ˜¾ç¤º/éšè—å¤‡ä»½é¢æ¿
        function toggleBackupsPanel() {
            const panel = document.getElementById('backups-panel');
            panel.classList.toggle('show');
        }

        async function handleFileOpen(handle) {
            try {
                console.log("Opening file:", handle.name);
                fileHandle = handle;
                const file = await fileHandle.getFile();
                const content = await file.text();
                console.log("File content loaded, length:", content.length);
                
                editor.textContent = content;
                // ç¡®ä¿éšè— placeholder
                hideFilePlaceholder();
                
                connectWebSocket(fileHandle.name);
                startFileSync();
                updateBackupList();
                
                // æ˜¾ç¤ºå¿«æ·é”®æç¤º
                const tip = document.getElementById('shortcut-tip');
                tip.classList.add('show');
                setTimeout(() => {
                    tip.classList.remove('show');
                }, 3000);
            } catch (err) {
                console.error("Error opening file:", err);
                alert("Failed to open file: " + err.message);
            }
        }

        // æ‹–æ”¾å¤„ç†
        editor.ondragover = (e) => {
            e.preventDefault();
            editor.classList.add('dragover');
        };
        
        editor.ondragleave = () => {
            editor.classList.remove('dragover');
        };
        
        editor.ondrop = async (e) => {
            e.preventDefault();
            editor.classList.remove('dragover');
            
            if (e.dataTransfer.items) {
                const item = e.dataTransfer.items[0];
                if (item.kind === 'file') {
                    try {
                        const handle = await item.getAsFileSystemHandle();
                        if (handle.kind === 'file') {
                            await handleFileOpen(handle);
                        }
                    } catch (err) {
                        console.error('Error opening dropped file:', err);
                    }
                }
            }
        };

        // æ–‡ä»¶åŒæ­¥
        async function startFileSync() {
            if (syncInterval) clearInterval(syncInterval);

            async function sync() {
                if (!fileHandle) return;
                
                try {
                    const file = await fileHandle.getFile();
                    const content = await file.text();
                    
                    if (content !== lastContent) {
                        lastContent = content;
                        if (content !== editor.textContent) {
                            isUpdating = true;
                            if (isPreviewMode) {
                                // åœ¨é¢„è§ˆæ¨¡å¼ä¸‹ï¼Œé‡æ–°æ¸²æŸ“å†…å®¹
                                if (!previewRenderer) {
                                    previewRenderer = new PreviewRenderer();
                                }
                                const fileType = previewRenderer.getFileType(fileHandle.name);
                                const renderedContent = previewRenderer.render(content, fileType);
                                editor.innerHTML = renderedContent;
                            } else {
                                editor.textContent = content;
                            }
                            if (ws?.readyState === WebSocket.OPEN) {
                                ws.send(JSON.stringify({
                                    type: "edit",
                                    content: content
                                }));
                            }
                            setTimeout(() => isUpdating = false, 100);
                        }
                    }

                    const timeSinceLastEdit = Date.now() - lastEditTime;
                    if (timeSinceLastEdit > 10000 && currentSyncInterval !== INTERVALS.INACTIVE) {
                        currentSyncInterval = INTERVALS.INACTIVE;
                        restartSync();
                    }
                } catch (err) {
                    console.error('Error syncing file:', err);
                }
            }

            function restartSync() {
                clearInterval(syncInterval);
                syncInterval = setInterval(sync, currentSyncInterval);
            }

            restartSync();
        }

        // WebSocketè¿æ¥å¤„ç†
        function connectWebSocket(fileId) {
            if (ws) ws.close();

            ws = new WebSocket(`ws://${window.location.host}/ws/${encodeURIComponent(fileId)}`);
            
            ws.onopen = () => {
                editor.disabled = false;
                showStatus(true);
            };

            ws.onclose = () => {
                editor.disabled = true;
                showStatus(false);
                // åªæœ‰åœ¨æ²¡æœ‰æ–‡ä»¶æ‰“å¼€æ—¶æ‰æ˜¾ç¤º placeholder
                if (!fileHandle) {
                    showFilePlaceholder();
                }
                setTimeout(() => {
                    if (fileHandle) connectWebSocket(fileHandle.name);
                }, 3000);
            };

            ws.onmessage = async (event) => {
                const data = JSON.parse(event.data);
                if (data.type === "update" && (!isUpdating || isPreviewMode)) {
                    try {
                        const writable = await fileHandle.createWritable();
                        await writable.write(data.content);
                        await writable.close();
                        
                        if (isPreviewMode) {
                            // åœ¨é¢„è§ˆæ¨¡å¼ä¸‹ï¼Œé‡æ–°æ¸²æŸ“å†…å®¹
                            if (!previewRenderer) {
                                previewRenderer = new PreviewRenderer();
                            }
                            const fileType = previewRenderer.getFileType(fileHandle.name);
                            const renderedContent = previewRenderer.render(data.content, fileType);
                            editor.innerHTML = renderedContent;
                        } else {
                            editor.textContent = data.content;
                        }
                    } catch (err) {
                        console.error('Error handling file update:', err);
                    }
                }
            };
        }

        // æ·»åŠ å·®å¼‚è®¡ç®—å‡½æ•°
        function calculateDiff(oldContent, newContent) {
            // ç®€å•çš„å·®å¼‚æ£€æµ‹ï¼Œè¿”å›å˜æ›´çš„å¼€å§‹ä½ç½®å’Œå†…å®¹
            let start = 0;
            while (start < oldContent.length && 
                   start < newContent.length && 
                   oldContent[start] === newContent[start]) {
                start++;
            }
            
            let end = 0;
            while (end < oldContent.length - start && 
                   end < newContent.length - start && 
                   oldContent[oldContent.length - 1 - end] === newContent[newContent.length - 1 - end]) {
                end++;
            }
            
            return {
                start,
                content: newContent.slice(start, newContent.length - end),
                oldLength: oldContent.length
            };
        }

        // ä¿®æ”¹ç¼–è¾‘å™¨è¾“å…¥å¤„ç†
        editor.addEventListener('input', async (e) => {
            if (!fileHandle || !ws || ws.readyState !== WebSocket.OPEN || isPreviewMode) return;
            
            lastEditTime = Date.now();
            updateSyncInterval();

            clearTimeout(typingTimer);
            typingTimer = setTimeout(async () => {
                try {
                    const newContent = editor.textContent;
                    const file = await fileHandle.getFile();
                    const oldContent = await file.text();
                    
                    // è®¡ç®—æ–‡ä»¶å¤§å°
                    const fileSize = newContent.length;
                    const isLargeFile = fileSize > 1000000; // 1MB
                    
                    // è®¡ç®—å†…å®¹å·®å¼‚
                    const diff = calculateDiff(oldContent, newContent);
                    const isDiffSmall = diff.content.length < 1000; // å°äº1KBçš„ä¿®æ”¹
                    
                    // æ ¹æ®æ–‡ä»¶å¤§å°å’Œä¿®æ”¹é‡é€‰æ‹©åŒæ­¥ç­–ç•¥
                    if (isLargeFile) {
                        if (isDiffSmall) {
                            // å¤§æ–‡å°ä¿®æ”¹ï¼šå¢é‡åŒæ­¥
                            await sendIncrementalUpdate(diff);
                        } else {
                            // å¤§æ–‡ä»¶å¤§ä¿®æ”¹ï¼šåˆ†å—åŒæ­¥
                            await sendChunkedUpdate(newContent);
                        }
                    } else {
                        // å°æ–‡ä»¶ï¼šç›´æ¥åŒæ­¥
                        await sendFullUpdate(newContent);
                    }
                    
                } catch (err) {
                    console.error('Error syncing file:', err);
                }
            }, 300);
        });

        // å¢é‡æ›´æ–°
        async function sendIncrementalUpdate(diff) {
            // å…ˆæ›´æ–°æœ¬åœ°æ–‡ä»¶
            const writable = await fileHandle.createWritable();
            await writable.seek(diff.start);
            await writable.write(diff.content);
            await writable.close();
            
            // å‘é€å¢é‡æ›´æ–°
            ws.send(JSON.stringify({
                type: "incremental_edit",
                start: diff.start,
                content: diff.content,
                oldLength: diff.oldLength
            }));
        }

        // åˆ†å—æ›´æ–°
        async function sendChunkedUpdate(content) {
            const chunkSize = 500000; // 500KB
            const chunks = Math.ceil(content.length / chunkSize);
            
            // å…ˆæ›´æ–°æœ¬åœ°æ–‡ä»¶
            const writable = await fileHandle.createWritable();
            await writable.write(content);
            await writable.close();
            
            // å‘é€åˆ†å—æ›´æ–°
            ws.send(JSON.stringify({
                type: "chunked_edit_start",
                totalChunks: chunks,
                totalSize: content.length
            }));
            
            for (let i = 0; i < chunks; i++) {
                ws.send(JSON.stringify({
                    type: "chunked_edit_chunk",
                    chunk: i,
                    content: content.slice(i * chunkSize, (i + 1) * chunkSize)
                }));
            }
        }

        // å®Œæ•´æ›´æ–°
        async function sendFullUpdate(content) {
            const writable = await fileHandle.createWritable();
            await writable.write(content);
            await writable.close();
            
            ws.send(JSON.stringify({
                type: "edit",
                content: content
            }));
        }

        function showStatus(connected) {
            status.className = `status ${connected ? 'connected' : 'disconnected'}`;
        }

        // ä¼˜åŒ–åŒæ­¥é—´éš”æ›´æ–°é€»è¾‘
        function updateSyncInterval() {
            const timeSinceLastEdit = Date.now() - lastEditTime;
            let newInterval = INTERVALS.INACTIVE;
            
            if (timeSinceLastEdit < 3000) {
                newInterval = INTERVALS.TYPING;
            } else if (timeSinceLastEdit < 30000) {
                newInterval = INTERVALS.ACTIVE;
            } else if (timeSinceLastEdit < 300000) {
                newInterval = INTERVALS.IDLE;
            }

            if (newInterval !== currentSyncInterval) {
                currentSyncInterval = newInterval;
                startFileSync();  // é‡å¯åŒæ­¥å®šæ—¶å™¨
            }
        }

        async function createBackup() {
            if (!fileHandle) return;
            const file = await fileHandle.getFile();
            const content = await file.text();
            const timestamp = new Date().toISOString();
            localStorage.setItem(`backup_${fileHandle.name}_${timestamp}`, content);
            updateBackupList();
        }

        function updateBackupList() {
            const backupList = document.getElementById('backup-list');
            backupList.innerHTML = '';
            
            if (!fileHandle) return;
            
            // è·å–å½“å‰æ–‡ä»¶çš„æ‰€æœ‰å¤‡ä»½
            const backups = Object.keys(localStorage)
                .filter(key => key.startsWith(`backup_${fileHandle.name}_`))
                .sort()
                .reverse();
            
            backups.forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                const date = new Date(key.split('_')[2]);
                option.textContent = date.toLocaleString(); // æ›´å‹å¥½çš„æ—¶é—´æ ¼å¼
                backupList.appendChild(option);
            });
        }

        async function restoreBackup() {
            const backupList = document.getElementById('backup-list');
            const selectedKey = backupList.value;
            if (!selectedKey || !fileHandle) return;
            
            const content = localStorage.getItem(selectedKey);
            if (content) {
                const writable = await fileHandle.createWritable();
                await writable.write(content);
                await writable.close();
                editor.textContent = content;
            }
        }

        // å®šæœŸåˆ›å»ºå¤‡ä»½ï¼ˆæ¯5åˆ†é’Ÿï¼‰
        setInterval(createBackup, 5 * 60 * 1000);

        // æ·»åŠ æ–°çš„ placeholder æ§åˆ¶å‡½æ•°
        function hideFilePlaceholder() {
            document.querySelector('.placeholder-text').style.display = 'none';
        }

        function showFilePlaceholder() {
            document.querySelector('.placeholder-text').style.display = 'block';
        }
    </script>
</body>
</html>